<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profilim - Kulüp Sistemi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .profile-img {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: 50%;
            border: 3px solid #007bff;
            cursor: pointer; /* Add cursor pointer to indicate it's clickable */
        }

        .footer {
            background-color: #f8f9fa;
            padding: 30px 0;
            text-align: center;
            margin-top: 50px;
        }
    </style>
</head>
<body>

    <script src="navbar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card shadow-sm p-4">
                    <h2 class="text-center mb-4">Profil Bilgilerim</h2>
                    <div class="text-center mb-4">
                        <img src="https://via.placeholder.com/150" class="profile-img" id="profileImage" alt="Profil Resmi">
                        <input type="file" id="profileImageUpload" accept="image/*" style="display: none;">
                        <h4 class="mt-3" id="profileName"></h4>
                        <p class="text-muted" id="profileUsername"></p>
                    </div>

                    <form id="profileForm">
                        <div class="mb-3">
                            <label for="firstName" class="form-label">Ad</label>
                            <input type="text" class="form-control" id="firstName" value="" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="lastName" class="form-label">Soyad</label>
                            <input type="text" class="form-control" id="lastName" value="" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">E-posta</label>
                            <input type="email" class="form-control" id="email" value="" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="phone" class="form-label">Telefon</label>
                            <input type="tel" class="form-control" id="phone" value="" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="createdTime" class="form-label">Kayıt Tarihi</label>
                            <input type="text" class="form-control" id="createdTime" value="" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="roles" class="form-label">Roller</label>
                            <input type="text" class="form-control" id="roles" value="" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="bio" class="form-label">Hakkımda</label>
                            <textarea class="form-control" id="bio" rows="3" readonly></textarea>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-primary" id="editProfileBtn">Bilgileri Düzenle</button>
                            <button type="submit" class="btn btn-success" id="saveProfileBtn" style="display: none;">Kaydet</button>
                            <button type="button" class="btn btn-secondary" id="cancelEditBtn" style="display: none;">İptal</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 Kulüp Yönetim Sistemi. Tüm Hakları Saklıdır.</p>
        </div>
    </footer>

    <script>
        // API_BASE_URL ve decodeJwtPayload, navbar.js'ten gelmektedir.
        const localUsername = localStorage.getItem('username'); // localStorage'dan kullanıcı adını çek

        // Profil verilerini yükleme
        async function fetchProfileData() {
            const accessToken = localStorage.getItem('accessToken');
            const refreshToken = localStorage.getItem('refreshToken'); // Refresh token da alalım

            if (!accessToken) {
                console.warn('AccessToken bulunamadı. Profil sayfasına erişim için giriş yapılmalı.');
                alert('Profilinizi görüntülemek için giriş yapmalısınız.');
                window.location.href = 'login.html';
                return;
            }

            console.log(`Profil detayları için API çağrılıyor: ${API_BASE_URL}/user/profil`);

            try {
                let response = await fetch(`${API_BASE_URL}/user/profil`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (response.status === 401 && refreshToken) {
                    console.warn('AccessToken süresi dolmuş veya geçersiz. Token yenileme deneniyor...');
                    const refreshResponse = await fetch(`${API_BASE_URL}/authentication/refresh`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ accessToken: accessToken, refreshToken: refreshToken })
                    });

                    if (refreshResponse.ok) {
                        const newTokens = await refreshResponse.json();
                        localStorage.setItem('accessToken', newTokens.accessToken);
                        localStorage.setItem('refreshToken', newTokens.refreshToken);
                        console.log('Tokenlar başarıyla yenilendi. Profil isteği yeniden deneniyor...');

                        response = await fetch(`${API_BASE_URL}/user/profil`, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${newTokens.accessToken}`
                            }
                        });
                    } else {
                        const errorText = await refreshResponse.text();
                        console.error('Token yenileme başarısız:', refreshResponse.status, errorText);
                        alert('Oturum süresi doldu veya geçersiz. Lütfen tekrar giriş yapın.');
                        window.location.href = 'login.html';
                        return;
                    }
                }

                if (!response.ok) {
                    throw new Error(`HTTP hatası! Durum: ${response.status} - ${response.statusText}`);
                }

                const profileData = await response.json();
                console.log("API'dan gelen profil verisi:", profileData);

                // HTML elementlerini doldur
                // If profileData.profilPhotoPath exists, try to download it
                if (profileData.profilPhotoPath) {
                    document.getElementById('profileImage').src = `${API_BASE_URL}/api/files/download?fileName=${profileData.profilPhotoPath}`;
                } else {
                    document.getElementById('profileImage').src = 'https://via.placeholder.com/150';
                }

                document.getElementById('profileName').textContent = `${profileData.firstName || ''} ${profileData.lastName || ''}`;
                document.getElementById('profileUsername').textContent = `@${localUsername || 'Bilinmiyor'}`;
                document.getElementById('firstName').value = profileData.firstName || '';
                document.getElementById('lastName').value = profileData.lastName || '';
                document.getElementById('email').value = profileData.email?.address || '';
                document.getElementById('phone').value = profileData.phoneNumber || '';
                document.getElementById('createdTime').value = profileData.createdTime ? new Date(profileData.createdTime).toLocaleDateString('tr-TR') : 'Bilinmiyor';
                document.getElementById('roles').value = profileData.roleNames ? profileData.roleNames.join(', ') : 'Bilinmiyor';
                document.getElementById('bio').value = ''; // DTO'da olmadığı için boş bırakılıyor

            } catch (error) {
                console.error('Profil verileri yüklenirken bir hata oluştu:', error);
                document.querySelector('.container').innerHTML = '<p class="text-center text-danger">Profil verileri yüklenemedi. Lütfen daha sonra tekrar deneyin.</p>';
            }
        }


        // Profil düzenleme işlevselliği
        const editProfileBtn = document.getElementById('editProfileBtn');
        const saveProfileBtn = document.getElementById('saveProfileBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const profileForm = document.getElementById('profileForm');
        const formInputs = profileForm.querySelectorAll('input, textarea');
        const profileImage = document.getElementById('profileImage');
        const profileImageUpload = document.getElementById('profileImageUpload');

        let selectedFile = null; // To store the selected file for upload

        profileImage.addEventListener('click', () => {
            if (!profileImageUpload.readOnly) { // Only allow upload when in edit mode
                profileImageUpload.click();
            }
        });

        profileImageUpload.addEventListener('change', (event) => {
            if (event.target.files.length > 0) {
                selectedFile = event.target.files[0];
                const reader = new FileReader();
                reader.onload = function (e) {
                    profileImage.src = e.target.result; // Display the new image instantly
                };
                reader.readAsDataURL(selectedFile);
            } else {
                selectedFile = null;
            }
        });


        editProfileBtn.addEventListener('click', () => {
            formInputs.forEach(input => {
                if (input.id !== 'profileUsername' && input.id !== 'createdTime' && input.id !== 'roles') {
                    input.readOnly = false;
                }
            });
            profileImageUpload.readOnly = false; // Enable image upload in edit mode
            editProfileBtn.style.display = 'none';
            saveProfileBtn.style.display = 'block';
            cancelEditBtn.style.display = 'block';
        });

        cancelEditBtn.addEventListener('click', () => {
            formInputs.forEach(input => input.readOnly = true);
            profileImageUpload.readOnly = true; // Disable image upload
            editProfileBtn.style.display = 'block';
            saveProfileBtn.style.display = 'none';
            cancelEditBtn.style.display = 'none';
            selectedFile = null; // Clear selected file
            fetchProfileData(); // Reload original data
        });

        profileForm.addEventListener('submit', async function (event) {
            event.preventDefault();

            const accessToken = localStorage.getItem('accessToken');
            if (!accessToken) {
                alert('Giriş yapmalısınız.');
                window.location.href = 'login.html';
                return;
            }

            let profilPhotoPath = null;
            if (selectedFile) {
                const formData = new FormData();
                formData.append('files', selectedFile); // 'files' must match the parameter name in your C# controller

                try {
                    const uploadResponse = await fetch(`${API_BASE_URL}/api/files/upload`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                            // 'Content-Type' is not needed for FormData; browser sets it with boundary
                        },
                        body: formData
                    });

                    if (!uploadResponse.ok) {
                        const errorDetails = await uploadResponse.text();
                        throw new Error(`Dosya yükleme hatası! Durum: ${uploadResponse.status}. Detay: ${errorDetails}`);
                    }

                    const uploadResult = await uploadResponse.json();
                    profilPhotoPath = uploadResult.file; // Get the filename from the upload response
                    console.log('Dosya yükleme başarılı:', uploadResult);

                } catch (error) {
                    console.error('Profil fotoğrafı yüklenirken hata:', error);
                    alert('Profil fotoğrafı güncellenirken bir hata oluştu: ' + error.message);
                    return; // Stop if image upload fails
                }
            }

            const updatedData = {
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                email: document.getElementById('email').value,
                phoneNumber: document.getElementById('phone').value,
                profilPhotoPath: profilPhotoPath // Include the new photo path if uploaded
            };

            console.log("Güncellenecek profil verileri:", updatedData);

            try {
                const response = await fetch(`${API_BASE_URL}/user/profil`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify(updatedData)
                });

                if (!response.ok) {
                    const errorDetails = await response.text();
                    throw new Error(`Profil güncelleme HTTP hatası! Durum: ${response.status} - ${response.statusText}. Detay: ${errorDetails}`);
                }

                const result = await response.json();
                alert('Profil bilgileriniz başarıyla güncellendi!');
                formInputs.forEach(input => input.readOnly = true);
                profileImageUpload.readOnly = true; // Disable image upload
                editProfileBtn.style.display = 'block';
                saveProfileBtn.style.display = 'none';
                cancelEditBtn.style.display = 'none';
                selectedFile = null; // Clear selected file
                fetchProfileData();

            } catch (error) {
                console.error('Profil güncelleme hatası:', error);
                alert('Profil güncellenirken bir hata oluştu: ' + error.message);
            }
        });

        document.addEventListener('DOMContentLoaded', fetchProfileData);
    </script>
</body>
</html>