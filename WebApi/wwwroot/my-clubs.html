<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Kulüplerim - Kulüp Sistemi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        .club-card-link {
            text-decoration: none;
            color: inherit;
        }

            .club-card-link .card {
                transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
                cursor: pointer;
            }

                .club-card-link .card:hover {
                    transform: translateY(-5px);
                    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                }

        .footer {
            background-color: #f8f9fa;
            padding: 30px 0;
            text-align: center;
            margin-top: 50px;
        }

        .club-card-img {
            height: 180px;
            object-fit: cover;
        }
    </style>
</head>
<body>
    <script src="navbar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <div class="container mt-4">
        <h2 class="mb-4">Kulüplerim</h2>

        <h3 class="mt-5 mb-3">Onaylanmış Kulüplerim</h3>
        <div id="approved-clubs-container" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        </div>
        <div id="approved-pagination" class="d-flex justify-content-center mt-4">
            <ul class="pagination"></ul>
        </div>


        <h3 class="mt-5 mb-3">Bekleyen Kulüp Üyelik İsteklerim</h3>
        <div id="pending-clubs-container" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        </div>
        <div id="pending-pagination" class="d-flex justify-content-center mt-4">
            <ul class="pagination"></ul>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 Kulüp Yönetim Sistemi. Tüm Hakları Saklıdır.</p>
        </div>
    </footer>

    <script>
        // API_BASE_URL navbar.js'ten gelmektedir.
        const USER_CLUBS_API_URL = `${API_BASE_URL}/user/clubuser/MyClubs`;

        let currentApprovedPage = 1;
        let totalApprovedPages = 1;
        let currentPendingPage = 1;
        let totalPendingPages = 1;
        const pageSize = 9; // Her sayfada gösterilecek kulüp sayısı

        const approvedClubsContainer = document.getElementById('approved-clubs-container');
        const pendingClubsContainer = document.getElementById('pending-clubs-container');
        const approvedPagination = document.querySelector('#approved-pagination .pagination');
        const pendingPagination = document.querySelector('#pending-pagination .pagination');

        async function fetchUserClubs() {
            const accessToken = localStorage.getItem('accessToken');
            const refreshToken = localStorage.getItem('refreshToken');

            if (!accessToken) {
                console.warn('AccessToken bulunamadı. Kulüpler sayfasına erişim için giriş yapılmalı.');
                alert('Kulüplerinizi görüntülemek için giriş yapmalısınız.');
                window.location.href = 'login.html';
                return;
            }

            try {
                let response = await fetch(`${USER_CLUBS_API_URL}?pageSize=${pageSize}&pageNumber=${currentApprovedPage}`, { // Tüm kulüpleri çekmek için şimdilik tek çağrı
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (response.status === 401 && refreshToken) {
                    console.warn('AccessToken süresi dolmuş veya geçersiz. Token yenileme deneniyor...');
                    const refreshResponse = await fetch(`${API_BASE_URL}/authentication/refresh`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ accessToken: accessToken, refreshToken: refreshToken })
                    });

                    if (refreshResponse.ok) {
                        const newTokens = await refreshResponse.json();
                        localStorage.setItem('accessToken', newTokens.accessToken);
                        localStorage.setItem('refreshToken', newTokens.refreshToken);
                        console.log('Tokenlar başarıyla yenilendi. Kulüp isteği yeniden deneniyor...');

                        // Yeniden istek göndermek için recursive çağrı yerine doğrudan response'u güncelle
                        response = await fetch(`${USER_CLUBS_API_URL}?pageSize=${pageSize}&pageNumber=${currentApprovedPage}`, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${newTokens.accessToken}`
                            }
                        });
                    } else {
                        const errorText = await refreshResponse.text();
                        console.error('Token yenileme başarısız:', refreshResponse.status, errorText);
                        alert('Oturum süresi doldu veya geçersiz. Lütfen tekrar giriş yapın.');
                        window.location.href = 'login.html';
                        return;
                    }
                }

                if (!response.ok) {
                    throw new Error(`HTTP hatası! Durum: ${response.status} - ${response.statusText}`);
                }

                const paginationHeader = response.headers.get('X-Pagination');
                const metaData = JSON.parse(paginationHeader);

                const userClubs = await response.json();
                console.log("API'dan gelen kullanıcı kulüp verileri:", userClubs);
                console.log("Pagination MetaData:", metaData);

                // Kulüpleri onay durumuna göre ayır
                const approvedClubs = userClubs.filter(club => club.approved === true);
                const pendingClubs = userClubs.filter(club => club.approved === false);

                renderClubs(approvedClubs, approvedClubsContainer);
                renderClubs(pendingClubs, pendingClubsContainer); // Her iki bölüm için de aynı render fonksiyonu kullanılabilir

                // Pagination'ı her iki bölüm için de ayrı ayrı güncelle
                // Not: Backend tek bir pagination metadata döndürdüğü için,
                // bu metadata'yı her iki liste için de kullanıyoruz.
                // Gerçek bir senaryoda, bu listelerin ayrı paginationları olsaydı,
                // backend'den ayrı metadata'lar gelmesi gerekirdi.
                // Şu an için basitlik adına toplam sayfa sayısını aynı tutuyoruz.
                totalApprovedPages = metaData.TotalPages;
                totalPendingPages = metaData.TotalPages;
                renderClubPagination(approvedPagination, currentApprovedPage, totalApprovedPages, (page) => {
                    currentApprovedPage = page;
                    fetchUserClubs(); // Sayfa değişince veriyi yeniden çek
                });
                renderClubPagination(pendingPagination, currentPendingPage, totalPendingPages, (page) => {
                    currentPendingPage = page;
                    fetchUserClubs(); // Sayfa değişince veriyi yeniden çek
                });


            } catch (error) {
                console.error('Kulüp verileri yüklenirken bir hata oluştu:', error);
                // Hata mesajlarını ayrı ayrı gösterebilirsiniz
                approvedClubsContainer.innerHTML = '<p class="col-12 text-center text-danger w-100">Onaylanmış kulüpler yüklenemedi. Lütfen daha sonra tekrar deneyin.</p>';
                pendingClubsContainer.innerHTML = '<p class="col-12 text-center text-danger w-100">Bekleyen kulüp istekleri yüklenemedi. Lütfen daha sonra tekrar deneyin.</p>';
            }
        }

        function renderClubs(clubs, containerElement) {
            containerElement.innerHTML = ""; // Önceki kartları temizle

            if (clubs.length === 0) {
                containerElement.innerHTML = '<p class="col-12 text-center text-muted">Burada gösterilecek kulüp bulunamadı.</p>';
                return;
            }

            clubs.forEach(club => {
                const clubCardHtml = `
                        <div class="col">
                            <div class="card h-100 shadow-sm">
                                <img src="https://via.placeholder.com/400x200?text=Kul%C3%BCp+Resmi" class="card-img-top club-card-img" alt="${club.clubClubName}">
                                <div class="card-body d-flex flex-column">
                                    <h5 class="card-title">${club.clubClubName}</h5>
                                    <p class="card-text text-muted mb-2">${club.clubDescription || 'Açıklama mevcut değil.'}</p>
                                    <ul class="list-unstyled mb-2 small">
                                        <li><i class="fas fa-user-circle me-1"></i> **Kullanıcı:** ${club.userFirstName} ${club.userLastName} (${club.userUserName})</li>
                                        <li><i class="fas fa-id-badge me-1"></i> **Kulüpteki Rolü:** ${club.role_in_club || 'Belirtilmemiş'}</li>
                                        <li><i class="fas fa-calendar-alt me-1"></i> **İstek Tarihi:** ${new Date(club.createdTime).toLocaleDateString('tr-TR')}</li>
                                        ${club.approvedTime ? `<li><i class="fas fa-check-circle me-1"></i> **Onay Tarihi:** ${new Date(club.approvedTime).toLocaleDateString('tr-TR')}</li>` : ''}
                                    </ul>
                                    <a href="clubdetail.html?id=${club.clubId}" class="btn btn-sm btn-outline-primary mt-auto">Detaylar</a>
                                    ${club.approved ? `<button class="btn btn-danger btn-sm mt-2 leave-club-btn" data-club-user-id="${club.id}">Ayrıl</button>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                containerElement.innerHTML += clubCardHtml;
            });

            // "Ayrıl" butonlarına olay dinleyicileri ekle
            containerElement.querySelectorAll('.leave-club-btn').forEach(button => {
                button.addEventListener('click', async (event) => {
                    const clubUserId = event.target.dataset.clubUserId;
                    const clubName = event.target.closest('.card').querySelector('.card-title').textContent;
                    if (confirm(`${clubName} kulübünden ayrılmak istediğinizden emin misiniz?`)) {
                        await handleLeaveClub(clubUserId, clubName);
                    }
                });
            });
        }

        async function handleLeaveClub(clubUserId, clubName) {
            const accessToken = localStorage.getItem('accessToken');
            if (!accessToken) {
                alert('Giriş yapmalısınız.');
                window.location.href = 'login.html';
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/user/clubuser/${clubUserId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (response.status === 204) { // 204 No Content for successful DELETE
                    alert(`${clubName} kulübünden başarıyla ayrıldınız.`);
                    fetchUserClubs(); // Kulüp listesini yenile
                } else {
                    const errorText = await response.text();
                    throw new Error(`Kulüpten ayrılırken hata oluştu: ${response.status} - ${errorText}`);
                }
            } catch (error) {
                console.error('Kulüpten ayrılma hatası:', error);
                alert('Kulüpten ayrılırken bir hata oluştu: ' + error.message);
            }
        }


        function renderClubPagination(paginationElement, currentPage, totalPages, pageChangeCallback) {
            paginationElement.innerHTML = "";

            if (totalPages <= 1) return;

            const createPageItem = (page, text, isActive = false, isDisabled = false) => {
                const li = document.createElement("li");
                li.className = `page-item ${isActive ? "active" : ""} ${isDisabled ? "disabled" : ""}`;

                const btn = document.createElement("button");
                btn.className = "page-link";
                btn.textContent = text;
                btn.addEventListener("click", () => {
                    if (!isDisabled && !isActive) {
                        pageChangeCallback(page);
                    }
                });

                li.appendChild(btn);
                return li;
            };

            // Previous button
            paginationElement.appendChild(createPageItem(currentPage - 1, "«", false, currentPage === 1));

            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                paginationElement.appendChild(createPageItem(i, i, i === currentPage));
            }

            // Next button
            paginationElement.appendChild(createPageItem(currentPage + 1, "»", false, currentPage === totalPages));
        }

        // Sayfa yüklendiğinde kulüpleri çek
        document.addEventListener("DOMContentLoaded", () => {
            fetchUserClubs();
        });
    </script>
</body>
</html>